<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Mon Blog</title>

  <!-- Lexend -->
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Barre d’accessibilité Faites-Mieux -->
  <link rel="stylesheet" href="https://alixb-accessible.github.io/faites-mieux-toolbar/faites-mieux.css">
  <script src="https://alixb-accessible.github.io/faites-mieux-toolbar/faites-mieux.js" defer></script>

  <style>
    :root {
      --bg: #ffffff;
      --surface: #f5f5f5;
      --text: #1a1a1a;
      --muted: #666666;
      --accent: #000000;
    }
    body {
      font-family: 'Lexend', sans-serif;
      margin: 0;
      padding: 24px;
      background: linear-gradient(135deg,#4a4a4a 0%,#4a4a4a 14.28%,#22c55e 14.28%,#22c55e 28.56%,#3b82f6 28.56%,#3b82f6 42.84%,#ffffff 42.84%,#ffffff 57.12%,#fbbf24 57.12%,#fbbf24 71.4%,#dc2626 71.4%,#dc2626 85.68%,#4a4a4a 85.68%,#4a4a4a 100%);
      min-height: 100vh;
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }
    .wrap { max-width: 1100px; margin: 0 auto; background: var(--bg); padding: 28px; border-radius: 14px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); }
    h1 { margin: 0 0 8px; font-size: 28px; }
    .row { display:flex; gap:16px; align-items:flex-start; margin-bottom:16px; flex-wrap:wrap; }
    .col { flex:1 1 300px; min-width: 260px; }
    label { display:block; font-weight:600; margin-bottom:6px; color:var(--text); }
    input[type="text"], input[type="email"], input[type="url"], textarea, select {
      width:100%; padding:10px; border-radius:8px; border:1px solid #e6e6e6; box-sizing:border-box;
      font-size:15px; color:var(--text);
    }
    textarea { min-height:120px; resize:vertical; }
    button { padding:10px 14px; border-radius:8px; border:0; cursor:pointer; font-weight:600; }
    .btn-primary { background:var(--accent); color:#fff; }
    .btn-secondary { background:#fff; color:var(--text); border:1px solid #ddd; }
    .small { font-size:13px; color:var(--muted); }
    .section { margin: 18px 0 28px; padding:16px; background:var(--surface); border-radius:10px; }
    .articles-list { max-height:360px; overflow:auto; padding:8px; border-radius:8px; background:#fff; border:1px solid #eee; }
    .article-item { padding:10px; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between; gap:8px; align-items:center; }
    .article-item:last-child { border-bottom:none; }
    .article-actions button { margin-left:8px; }
    .inline { display:inline-flex; gap:8px; align-items:center; }
    .muted { color:var(--muted); font-size:13px; }
    .flex { display:flex; gap:12px; align-items:center; }
    .tag { padding:6px 10px; background:#eee; border-radius:999px; display:inline-block; margin-right:6px; font-size:13px; }
    .notice { padding:10px; background:#fdf7e0; border-radius:8px; margin-bottom:12px; }
    /* focus */
    :focus { outline: 3px solid rgba(0,0,0,0.06); outline-offset: 2px; }
    @media (max-width:800px){ .row{flex-direction:column;} .col{min-width:100%} }
  </style>
</head>
<body>
  <main class="wrap" role="main">
    <header>
      <h1>Administration — Mon Blog</h1>
      <p class="small">Connecte-toi avec ton compte (Firebase email/password). Tu peux uploader des images et gérer articles, catégories, tags, archives et réglages.</p>
    </header>

    <!-- LOGIN -->
    <section id="login-section" class="section" aria-labelledby="login-heading">
      <h2 id="login-heading" style="margin-top:0">Connexion</h2>
      <form id="loginForm" class="row" aria-label="Formulaire de connexion">
        <div class="col">
          <label for="email">Email</label>
          <input id="email" type="email" autocomplete="email" required />
        </div>
        <div class="col">
          <label for="password">Mot de passe</label>
          <input id="password" type="password" autocomplete="current-password" required />
        </div>
        <div class="col" style="flex:0 0 auto;">
          <label>&nbsp;</label>
          <div class="inline">
            <button type="submit" class="btn-primary">Se connecter</button>
            <button id="logoutBtn" type="button" class="btn-secondary" style="display:none">Se déconnecter</button>
          </div>
        </div>
      </form>
      <div id="loginError" class="muted" role="status" aria-live="polite"></div>
    </section>

    <!-- ADMIN UI (hidden tant que non connecté) -->
    <section id="admin-ui" style="display:none">
      <!-- SETTINGS: titre, sous-titre, intro, couleurs -->
      <section class="section" aria-labelledby="settings-heading">
        <h2 id="settings-heading">Réglages du site</h2>
        <form id="settingsForm" class="row" aria-label="Réglages du blog">
          <div class="col">
            <label for="siteTitle">Titre du blog</label>
            <input id="siteTitle" type="text" placeholder="Mon Blog" />
          </div>
          <div class="col">
            <label for="siteSubtitle">Sous-titre</label>
            <input id="siteSubtitle" type="text" placeholder="Partagez vos idées avec le monde" />
          </div>
          <div class="col" style="flex-basis:100%">
            <label for="siteIntro">Présentation (introduction)</label>
            <textarea id="siteIntro" placeholder="Quelques mots pour présenter le blog..."></textarea>
          </div>
          <div class="col" style="flex-basis:100%">
            <label for="accentColor">Couleur accent (hex)</label>
            <input id="accentColor" type="text" placeholder="#000000" />
          </div>
          <div style="display:flex;gap:10px;width:100%">
            <button id="saveSettingsBtn" class="btn-primary" type="button">Enregistrer les réglages</button>
            <span class="small">Les réglages sont stockés dans Firestore (doc: <code>settings/general</code>).</span>
          </div>
        </form>
      </section>

      <!-- ARTICLE EDITOR -->
      <section class="section" aria-labelledby="editor-heading">
        <h2 id="editor-heading">Créer / Éditer un article</h2>
        <form id="articleForm" aria-label="Formulaire article">
          <input type="hidden" id="articleId">
          <div class="row">
            <div class="col">
              <label for="title">Titre</label>
              <input id="title" type="text" required />
            </div>
            <div class="col">
              <label for="excerpt">Extrait (court)</label>
              <input id="excerpt" type="text" />
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label for="categorySelect">Catégorie</label>
              <select id="categorySelect" aria-label="Choisir une catégorie"></select>
              <div style="margin-top:8px;">
                <input id="newCategory" type="text" placeholder="Nouvelle catégorie" style="width:60%;display:inline-block" />
                <button id="addCategoryBtn" class="btn-secondary" type="button" style="display:inline-block">Ajouter</button>
              </div>
            </div>

            <div class="col">
              <label for="tags">Tags (séparés par des virgules)</label>
              <input id="tags" type="text" placeholder="javascript, design, tuto" />
            </div>
          </div>

          <div style="margin-top:12px;">
            <label for="content">Contenu (HTML autorisé pour formatage : &lt;strong&gt;, &lt;em&gt;, &lt;a&gt;, &lt;img&gt; etc.)</label>
            <textarea id="content" placeholder="Écrire le contenu HTML ici" aria-multiline="true"></textarea>
            <p class="small">Astuce : tu peux coller du HTML simple (ex : &lt;p&gt;, &lt;strong&gt;, &lt;em&gt;, &lt;a href=''&gt;).</p>
          </div>

          <div class="row" style="margin-top:12px; align-items:center;">
            <div class="col">
              <label for="imageFile">Image principale (upload)</label>
              <input id="imageFile" type="file" accept="image/*" />
            </div>
            <div class="col">
              <label for="imageUrl">Ou image par URL</label>
              <input id="imageUrl" type="url" placeholder="https://..." />
            </div>
            <div class="col">
              <label for="imageAlt">Texte alternatif (alt)</label>
              <input id="imageAlt" type="text" placeholder="Description pour l'accessibilité" />
            </div>
          </div>

          <div style="margin-top:12px" class="row">
            <div class="col" style="flex-basis:200px">
              <label for="status">Statut</label>
              <select id="status">
                <option value="published">Publié</option>
                <option value="draft">Brouillon</option>
                <option value="archived">Archivé</option>
              </select>
            </div>
            <div class="col" style="flex-basis:100px;align-self:end">
              <button id="saveArticleBtn" class="btn-primary" type="button">Publier / Enregistrer</button>
            </div>
            <div class="col" style="flex-basis:120px;align-self:end">
              <button id="clearFormBtn" class="btn-secondary" type="button">Réinitialiser</button>
            </div>
          </div>
        </form>
      </section>

      <!-- LISTE D'ARTICLES -->
      <section class="section" aria-labelledby="list-heading">
        <h2 id="list-heading">Articles</h2>
        <div class="row">
          <div style="flex:1">
            <input id="filterInput" type="text" placeholder="Rechercher..." aria-label="Rechercher dans la liste" />
          </div>
          <div style="flex:0 0 200px">
            <select id="filterStatus">
              <option value="">Tous</option>
              <option value="published">Publié</option>
              <option value="draft">Brouillon</option>
              <option value="archived">Archivé</option>
            </select>
          </div>
        </div>

        <div class="articles-list" id="articlesList" tabindex="0" aria-live="polite"></div>
      </section>
    </section>
  </main>

  <!-- FIREBASE + LOGIQUE ADMIN -->
  <script type="module">
    // Imports Firebase (modulaire)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, setDoc, getDocs, query, where, orderBy, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

    // Ta config Firebase — laisse telle quelle (tu as déjà configuré le projet)
    const firebaseConfig = {
      apiKey: "AIzaSyAf5L19V1ktK9wKGU87P30xNN9jde4-_Eg",
      authDomain: "page-admin-tiracoon-blog.firebaseapp.com",
      projectId: "page-admin-tiracoon-blog",
      storageBucket: "page-admin-tiracoon-blog.firebasestorage.app",
      messagingSenderId: "1091401553072",
      appId: "1:1091401553072:web:0ddc04b952de5ed1225775"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // --- éléments DOM
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const logoutBtn = document.getElementById('logoutBtn');
    const adminUi = document.getElementById('admin-ui');

    const settingsForm = document.getElementById('settingsForm');
    const siteTitleInput = document.getElementById('siteTitle');
    const siteSubtitleInput = document.getElementById('siteSubtitle');
    const siteIntroInput = document.getElementById('siteIntro');
    const accentColorInput = document.getElementById('accentColor');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');

    const articleForm = document.getElementById('articleForm');
    const articleIdInput = document.getElementById('articleId');
    const titleInput = document.getElementById('title');
    const excerptInput = document.getElementById('excerpt');
    const contentInput = document.getElementById('content');
    const categorySelect = document.getElementById('categorySelect');
    const newCategory = document.getElementById('newCategory');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const tagsInput = document.getElementById('tags');
    const imageFileInput = document.getElementById('imageFile');
    const imageUrlInput = document.getElementById('imageUrl');
    const imageAltInput = document.getElementById('imageAlt');
    const statusSelect = document.getElementById('status');
    const saveArticleBtn = document.getElementById('saveArticleBtn');
    const clearFormBtn = document.getElementById('clearFormBtn');

    const articlesList = document.getElementById('articlesList');
    const filterInput = document.getElementById('filterInput');
    const filterStatus = document.getElementById('filterStatus');

    // --- login
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginError.textContent = '';
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        loginError.textContent = 'Connexion échouée — ' + err.message;
      }
    });

    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, user => {
      if (user) {
        adminUi.style.display = 'block';
        document.getElementById('login-section').style.display = 'none';
        logoutBtn.style.display = 'inline-flex';
        loadSettings();
        loadCategories();
        loadArticlesList();
      } else {
        adminUi.style.display = 'none';
        document.getElementById('login-section').style.display = 'block';
        logoutBtn.style.display = 'none';
      }
    });

    // --- SETTINGS (settings/general)
    async function loadSettings() {
      try {
        const settingsRef = doc(db, 'settings', 'general');
        const snap = await getDoc(settingsRef);
        if (snap && snap.exists()) {
          const data = snap.data();
          siteTitleInput.value = data.title || '';
          siteSubtitleInput.value = data.subtitle || '';
          siteIntroInput.value = data.intro || '';
          accentColorInput.value = data.accent || '#000000';
        } else {
          // valeurs par défaut
          siteTitleInput.value = document.title || 'Mon Blog';
        }
      } catch (err) {
        console.error('Erreur loadSettings', err);
      }
    }

    saveSettingsBtn.addEventListener('click', async () => {
      const settingsRef = doc(db, 'settings', 'general');
      try {
        await setDoc(settingsRef, {
          title: siteTitleInput.value,
          subtitle: siteSubtitleInput.value,
          intro: siteIntroInput.value,
          accent: accentColorInput.value
        }, { merge: true });
        alert('Réglages enregistrés.');
      } catch (err) {
        alert('Erreur enregistrement: ' + err.message);
      }
    });

    // --- CATEGORIES
    async function loadCategories() {
      // Récupère les catégories uniques depuis les articles ou une collection 'categories'
      const cats = new Set();
      const snap = await getDocs(collection(db, 'articles'));
      snap.forEach(d => {
        const c = d.data().category;
        if (c) cats.add(c);
      });
      // ajoute aussi depuis collection categories si tu souhaites (pas obligatoire)
      // vider et remplir le select
      categorySelect.innerHTML = '<option value="">Aucune</option>';
      Array.from(cats).sort().forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        categorySelect.appendChild(opt);
      });
    }

    addCategoryBtn.addEventListener('click', () => {
      const val = newCategory.value.trim();
      if (!val) return;
      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = val;
      categorySelect.appendChild(opt);
      categorySelect.value = val;
      newCategory.value = '';
    });

    // --- UPLOAD IMAGE (to Firebase Storage)
    async function uploadImageFile(file) {
      if (!file) return null;
      const path = `article-images/${Date.now()}-${file.name.replace(/\s/g,'_')}`;
      const ref = storageRef(storage, path);
      const snap = await uploadBytes(ref, file);
      const url = await getDownloadURL(snap.ref);
      return url;
    }

    // --- ARTICLES: create / update / delete / list
    saveArticleBtn.addEventListener('click', async () => {
      saveArticleBtn.disabled = true;
      try {
        let imageUrl = imageUrlInput.value.trim();
        if (imageFileInput.files && imageFileInput.files[0]) {
          // upload file and get URL
          imageUrl = await uploadImageFile(imageFileInput.files[0]);
        }
        const payload = {
          title: titleInput.value.trim(),
          excerpt: excerptInput.value.trim(),
          content: contentInput.value.trim(),
          category: categorySelect.value || null,
          tags: tagsInput.value.trim(),
          imageUrl: imageUrl || null,
          imageAlt: imageAltInput.value.trim() || null,
          status: statusSelect.value || 'published',
          updatedAt: new Date().toISOString(),
        };

        const id = articleIdInput.value;
        if (id) {
          const ref = doc(db, 'articles', id);
          await updateDoc(ref, payload);
          alert('Article mis à jour');
        } else {
          payload.createdAt = new Date().toISOString();
          await addDoc(collection(db, 'articles'), payload);
          alert('Article ajouté');
        }

        // reset form & reload list
        articleForm.reset();
        articleIdInput.value = '';
        loadCategories();
        loadArticlesList();
      } catch (err) {
        alert('Erreur sauvegarde: ' + err.message);
        console.error(err);
      } finally {
        saveArticleBtn.disabled = false;
      }
    });

    async function loadArticlesList() {
      articlesList.innerHTML = '<div class="muted">Chargement…</div>';
      try {
        const snaps = await getDocs(query(collection(db, 'articles'), orderBy('createdAt','desc')));
        const arr = [];
        snaps.forEach(d => arr.push({ id: d.id, ...d.data() }));
        renderArticlesList(arr);
      } catch (err) {
        articlesList.innerHTML = '<div class="muted">Erreur chargement</div>';
        console.error(err);
      }
    }

    function renderArticlesList(items) {
      articlesList.innerHTML = '';
      items.forEach(it => {
        const div = document.createElement('div');
        div.className = 'article-item';
        const left = document.createElement('div');
        left.innerHTML = `<div><strong>${escapeHtml(it.title || '(sans titre)')}</strong><div class="small muted">${it.category || '—'} • ${it.status || '—'} • ${formatDate(it.createdAt)}</div></div>`;
        const actions = document.createElement('div');
        actions.className = 'article-actions';
        actions.innerHTML = `
          <button class="btn-secondary" onclick='populateEdit("${it.id}")'>Modifier</button>
          <button class="btn-secondary" onclick='toggleStatus("${it.id}")'>Basculer statut</button>
          <button class="btn-secondary" onclick='deleteArticle("${it.id}")' style="background:#fee;color:#900">Supprimer</button>
        `;
        div.appendChild(left);
        div.appendChild(actions);
        articlesList.appendChild(div);
      });
    }

    // helper: escape HTML for safety in listings
    function escapeHtml(str){ return String(str || '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

    // populate form for editing an article
    window.populateEdit = async function(id) {
      try {
        const ref = doc(db, 'articles', id);
        const snap = await getDoc(ref);
        if (!snap.exists()) { alert('Article introuvable'); return; }
        const d = snap.data();
        articleIdInput.value = id;
        titleInput.value = d.title || '';
        excerptInput.value = d.excerpt || '';
        contentInput.value = d.content || '';
        categorySelect.value = d.category || '';
        tagsInput.value = d.tags || '';
        imageUrlInput.value = d.imageUrl || '';
        imageAltInput.value = d.imageAlt || '';
        statusSelect.value = d.status || 'published';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (err) {
        alert('Erreur: ' + err.message);
      }
    };

    // toggle status: cycle published -> archived -> draft -> published
    window.toggleStatus = async function(id) {
      try {
        const ref = doc(db, 'articles', id);
        const snap = await getDoc(ref);
        if (!snap.exists()) return;
        const cur = snap.data().status || 'published';
        const next = cur === 'published' ? 'archived' : cur === 'archived' ? 'draft' : 'published';
        await updateDoc(ref, { status: next, updatedAt: new Date().toISOString() });
        loadArticlesList();
      } catch (err) {
        alert('Erreur: ' + err.message);
      }
    };

    // delete
    window.deleteArticle = async function(id) {
      if (!confirm('Confirmer la suppression ?')) return;
      try {
        await deleteDoc(doc(db, 'articles', id));
        loadArticlesList();
      } catch (err) {
        alert('Erreur suppression: ' + err.message);
      }
    };

    // filter / search local (simple)
    filterInput.addEventListener('input', () => {
      const q = filterInput.value.trim().toLowerCase();
      const status = filterStatus.value;
      // reload and filter client-side
      (async () => {
        const snaps = await getDocs(query(collection(db,'articles'), orderBy('createdAt','desc')));
        const arr = [];
        snaps.forEach(d => arr.push({ id: d.id, ...d.data() }));
        const filtered = arr.filter(a => {
          if (status && a.status !== status) return false;
          if (!q) return true;
          return (a.title||'').toLowerCase().includes(q) || (a.excerpt||'').toLowerCase().includes(q) || (a.content||'').toLowerCase().includes(q);
        });
        renderArticlesList(filtered);
      })();
    });

    filterStatus.addEventListener('change', loadArticlesList);

    // clear form
    clearFormBtn.addEventListener('click', () => {
      articleForm.reset();
      articleIdInput.value = '';
    });

    // small helpers
    function formatDate(s) {
      if (!s) return '';
      try { return new Date(s).toLocaleString(); } catch { return s; }
    }

    // convenience getDoc wrapper
    async function getDoc(ref) {
      try { return await getDocOrig(ref); } catch(e) { return null; }
    }

    // polyfill name conflict - we imported getDoc earlier? ensure it's available
    import { getDoc as getDocOrig } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // initial load helpers
    // (already called on auth state change)

  </script>
</body>
</html>
